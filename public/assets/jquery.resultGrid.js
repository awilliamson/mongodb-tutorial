!function(e){e.fn.resultGrid=function(t){return"draw"==t.command?this.each(function(){this.resultGrid.draw(t.parameters,t.data)}):"page"==t.command?this.each(function(){this.resultGrid.page(t.to)}):this.each(function(){if(this.resultGrid)return!1;var t,n,r,i=this,o=e(this),s={initialize:function(){s.reset(),e(window).keydown(s.keystroke)},reset:function(){e("#results").undelegate("tbody td div","dblclick"),e("#results").delegate("tbody td div","dblclick",s.clicked),t={},n={}},clicked:function(){var t=e(this);if(t.is(":not(.expanded)")){var n=o.offset(),i=t.parent().offset();t.addClass("expanded").css({top:i.top-n.top-6,left:i.left-n.left-1})}return t.css({zIndex:r++}),!1},keystroke:function(e){return 27==e.which&&(o.find("div.expanded").removeClass("expanded"),r=1),!0},draw:function(e,t){s.useExisting(e)||s.reset(),r=1,o.empty(),n=e,s.loadHeaders(t.documents),s.loadData(t.documents),s.loadPager(t.count,t.documents.length,t.limit,e?e.skip:0)},useExisting:function(r){return e.resultGrid.same(t,{})?!0:null!=r&&null!=n&&r.collection==n.collection&&e.resultGrid.same(r.selector,n.selector)&&e.resultGrid.same(r.fields,n.fields)},loadHeaders:function(e){for(var n=e.length,r=0;n>r;++r)for(var i in e[r])t[i]=1},loadData:function(e){for(var n=1==t._id,r=e.length,o=0;r>o;++o){var a=i.insertRow(-1);n&&s.createCell(a,renderer.getValue(e[o]._id));for(var c in t)"_id"!=c&&s.createCell(a,renderer.getValue(e[o][c]))}var l=i.createTHead(),a=l.insertRow(0);n&&s.createCell(a,"_id");for(var c in t)"_id"!=c&&s.createCell(a,c)},createCell:function(e,t){var n=e.insertCell(-1);n.innerHTML="<div>"+t+"</div>"},loadPager:function(t,n,r,i){isNaN(i)&&(i=0),e("#pager").pager({command:"refresh",data:[t,n,r,i]})},page:function(e){var t="db."+n.collection+".find(";(n.selector||n.fields)&&(t+=n.selector?JSON.stringify(n.selector):"{}"),n.fields&&(t+=", "+JSON.stringify(n.fields)),t+=")",e&&(t+=".skip("+e+")"),n.limit&&(t+=".limit("+n.limit+")"),n.sort&&(t+=".sort("+JSON.stringify(n.sort)+")"),t+=";",executor.rawExecute(t)}};this.resultGrid=s,s.initialize()})}}(jQuery),$.resultGrid={display:function(e,t){$.isArray(e.documents)||(e.documents=[e.documents]);var n=$("#grid");return 0==n.length&&(n=$('<table id="grid">').resultGrid({})),n.resultGrid({command:"draw",parameters:t,data:e}),n},same:function(e,t){if(!t)return!1;for(var n in e)if(e[n]!=t[n])return!1;return!0}};